[TOC]

# NoSQL

Not only SQL。

NoSQL概念的发展历史：
![1](./images/1.png)

随着大数据时代的到来，越来越多的网站、应用系统需要支撑海量数据存储，高并发请求、高可用、高可扩展性等特性要求，传统的关系型数据库在应付这些调整已经显得力不从心，暴露了许多能以克服的问题。由此，各种各样的NoSQL（Not Only SQL）数据库作为传统关系型数据的一个有力补充得到迅猛发展。

## 1. 传统数据库的缺点

- 大数据场景下I/O较高
因为数据是按行存储，即使只针对其中某一列进行运算，关系型数据库也会将整行数据从存储设备中读入内存，导致I/O较高

- 存储的是行记录，无法存储数据结构

- 表结构schema扩展不方便
如要需要修改表结构，需要执行执行DDL(data definition language)，语句修改，修改期间会导致锁表，部分服务不可用

- 全文搜索功能较弱
关系型数据库下只能够进行子字符串的匹配查询，当表的数据逐渐变大的时候，like查询的匹配会非常慢，即使在有索引的情况下。况且关系型数据库也不应该对文本字段进行索引

- 存储和处理复杂关系型数据功能较弱
许多应用程序需要了解和导航高度连接数据之间的关系，才能启用社交应用程序、推荐引擎、欺诈检测、知识图谱、生命科学和 IT/网络等用例。然而传统的关系数据库并不善于处理数据点之间的关系。它们的表格数据模型和严格的模式使它们很难添加新的或不同种类的关联信息。

## 2. NoSQL解决方案及类型

在NoSQL许多方面性能大大优于非关系型数据库的同时，往往也伴随一些特性的缺失，比较常见的，是事务库事务功能的缺失。

数据库事务正确执行的四个基本要素：ACID如下：

简写 | 名称 | 描述
- | - | -
A | Atomicity(原子性) | 一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样。
C | Consistency 一致性 | 在事务开始之前和事务结束以后，数据库数据的一致性约束没有被破坏。
I | Isolation 隔离性 | 数据库允许多个并发事务同时对数据进行读写和修改的能力。隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。
D | Durability 持久性 | 事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

### 2.1 文档型数据库

文档数据库（也称为文档型数据库）是旨在将半结构化数据存储为文档的一种数据库。文档数据库通常以 JSON 或 XML 格式存储数据。

由于文档数据库的no-schema特性，可以存储和读取任意数据。

由于使用的数据格式是JSON或者BSON，因为JSON数据是自描述的，无需在使用前定义字段，读取一个JSON中不存在的字段也不会导致SQL那样的语法错误，可以解决关系型数据库表结构schema扩展不方便的问题。

1. 特点
   面向集合存储，模式自由，使用高效的二进制数据存储等。

2. 代表
   MongoDB、CouchDB、CouchBase、MarkLogic、Clusterpoint

3. 优缺点

以MongoDB为例进行说明

**优点如下：**

- 新增字段简单
  无需像关系型数据库一样先执行DDL语句修改表结构，程序代码直接读写即可
- 容易兼容历史数据
  对于历史数据，即使没有新增的字段，也不会导致错误，只会返回空值，此时代码兼容处理即可
- 容易存储复杂数据
  JSON是一种强大的描述语言，能够描述复杂的数据结构

相比传统关系型数据库，文档数据库的缺点主要是对多条数据记录的事务支持较弱，具体体现如下：

- Atomicity(原子性)
仅支持单行/文档级原子性，不支持多行、多文档、多语句原子性
- Isolation(隔离性)
隔离级别仅支持已提交读（Read committed）级别，可能导致不可重复读，幻读的问题
- 不支持复杂查询
例如join查询，如果需要join查询，需要多次操作数据库

MongonDB还是支持多文档事务的Consistency(一致性)和Durability(持久性)

4. 应用场景

- 适用于数据变化较少，执行预定义查询，进行数据统计的应用程序。
- 适用于需要提供数据版本支持的应用程序。
- 数据量很大或者未来会变得很大;
- 表结构不明确，且字段在不断增加，例如内容管理系统，信息管理系统。

不适用场景：

- 在不同的文档上需要添加事务。Document-Oriented数据库并不支持文档间的事务。
- 多个文档之间需要复杂查询，例如join。

### 2.2 键值存储数据库

1. 特点
   以键为索引的存储方式，访问速度极快。

2. 代表
   Dynamo、FoundationDB、MemcacheDB、Redis、Riak、Aerospike、LevelDB、Scalaris、Voldemort、HyperDex、Berkeley DB、Apache Accumulo、Apache Cassandra。

3. 优缺点

以Redis为例：

**优点如下：**

- 性能极高：Redis能支持超过10W的TPS
- 丰富的数据类型： Redis支持包括String，Hash，List，Set，Sorted Set，Bitmap和hyperloglog
- 丰富的特性：Redis还支持 publish/subscribe, 通知, key 过期等等特性

**缺点如下：**

- 针对ACID，Redis事务不能支持原子性和持久性(A和D)，只支持隔离性和一致性(I和C)

特别说明一下，这里所说的无法保证原子性，是针对Redis的事务操作，因为事务是不支持回滚（roll back），而因为Redis的单线程模型，Redis的普通操作是原子性的

大部分业务不需要严格遵循ACID原则，例如游戏实时排行榜，粉丝关注等场景，即使部分数据持久化失败，其实业务影响也非常小。因此在设计方案时，需要根据业务特征和要求来做选择。

4. 应用场景

- 适用场景
储存用户信息(比如会话)、配置文件、参数、购物车等等。这些信息一般都和ID（键）挂钩

- 不适用场景
  - 需要通过值来查询，而不是键来查询。Key-Value数据库中根本没有通过值查询的途径。
  - 需要储存数据之间的关系。在Key-Value数据库中不能通过两个或以上的键来关联数据
  - 需要事务的支持。在Key-Value数据库中故障产生时不可以进行回滚。

### 2.3 图数据库

特点：以节点/关系/属性为基础存储数据，善于处理大量复杂、互连接、低结构化的数据。

代表：Neo4j、OrientDB、ArangoDB、MapGraph

应用场景：社会关系，公共交通网络，地图及网络拓谱。

### 2.4 列式数据库

特点：以列相关存储架构进行数据存储，适合于批量数据处理和即席查询。

代表：Cassandra、HBase、Accumulo、Druid、Vertica、BigTable

应用场景：适合于批量数据处理和即席查询。

### 2.5 内存数据库

特点：将数据放在内存中直接操作，数据处理速度比传统数据库的数据处理速度要快很多。

代表：Redis、Membase

应用场景：适用于数据变化快且数据库大小可预见(适合内存容量)的应用程序。

### 2.6 XML数据库

特点：高效存储XML数据，并支持XML内部查询语法。

## 参考

1. [如何学习及选择大数据非关系型数据库NoSQL](https://zhuanlan.zhihu.com/p/28649559)
2. [NoSQL 还是 SQL ？这一篇讲清楚](https://www.jianshu.com/p/296bacba3510)
3. [大数据时代的 9 大Key-Value存储数据库](https://www.iteye.com/blog/elf8848-2083165)
