[TOC]

# 幂等性

幂等，Idempotent，是一个数学和计算机概念，数学形式如下表示：$f(n)= 1^n$。从数学表示上我们理解，幂等就是不论操作多少遍，结果都是一样的。

用在实际系统中，幂等性指的是一个操作，执行任意多遍和执行一遍的效果是一样的。这么表述还是不够清晰的，我们再换一种表述：一个方法或者系统，你输入相同的参数，执行任意多次，最终获得的结果都是一样的。这是为了保证系统不会因为重复执行了相同的操作而造成系统多次改变。

比如以下的场景：

- 前端重复提交选中的数据，后台也只会对应这个数据的一个反应。
- 用户发起一笔付款请求，就应该只扣一次钱，即使遇到网络重发或系统Bug重发请求，也应该只扣一次钱。
- 发送验证消息也应该只发一次，同样的验证短信不应该发送多次。
- 创建业务订单，一个业务请求只能创建一个业务订单，创建多个就会严重有问题。

## 1. 幂等性的技术方案

### 1.1 “增删改查”幂等性

从用户在执行某项操作，接口是否保证满足用户意图的情况，来分析思考幂等性。

1. 查询操作

查询天然幂等性，因为查询并不修改系统数据。

2. 删除操作

删除操作也是幂等，删除一次和删除多次都是把数据删除。

3. 更新操作

更新操作中有些修改时幂等的，比如把某个字段设置为某个值。但有些操作不是幂等的，比如把某个值增加1的操作。

4. 新增操作

增加数据的操作也会出现不是幂等性问题，需要仔细设计。

### 1.2 常用解决方案

核心思想是保证请求有唯一性标识，后端可以通过这个标识**判断是否是重复请求**，决定是否执行。通过保证重复操作不被有效执行，来保证幂等性。

1. 唯一索引机制

通过底层系统的提供的唯一索引机制，可以解决新增数据的重复问题。

2. token机制

token机制可以防止页面重复提交。提交数据前从服务器申请一个带有有效时间的Token，然后Token放到Redis或者JVM内存中。当数据提交后，后台检验Token，然后删除相应的Token，这样携带相同Token的重复请求就会因为Token变得无效而不再执行。

3. select + insert

对于一些并发不高的系统，为了支持幂等操作，最简单的做法就是先做一次查询，判断是否已经执行，然后在进行业务处理。

4. 状态机幂等

一个业务操作涉及多个状态，这些状态构建成一个有限状态机，状态会在不同的条件下发生变更，状态的变更是有先后顺序的，如果状态机处于下一个状态，却来了一个上一个状态的变更，理论上是不能够变更的，这样保证了有限状态机的幂等性。

## 2. 关于幂等性的思考

接口设计中提到的幂等性，指的是我们通过接口提供了“增删改查”的能力，但是“改和增”有关的操作，我们无法控制接口调用过程中出现的“重复操作异常”，如果重复操作其实用户不想产生叠加的影响，那么我们就要考虑通过一定的方式来保证重复操作不会产生不想要的效果。

在设计接口时，需要考虑“改和增”两种类型的接口是否有幂等性的要求，如果有，就要考虑用一定的方式保证幂等性。
