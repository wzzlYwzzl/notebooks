[TOC]

# 控制打包的内容

有时我们希望 resource 目录下面的部分内容被打包到 jar 或者 war 包中，如何做呢？

为了对 maven 打包有一个比较完整的理解，下面从基础讲解相关知识，最后再给出实现方式。

## 1. maven 项目的标准目录结构

- src

  - main
    - java 源文件
    - resources 资源文件
    - filters 资源过滤文件
    - config 配置文件
    - scripts 脚本文件
    - webapp web 应用文件
  - test
    - java 测试源文件
    - resources 测试资源文件
    - filters 测试资源过滤文件
  - it 集成测试
  - assembly assembly descriptors
  - site Site

- target

  - generated-sources
  - classes
  - generated-test-sources
  - test-classes
  - xxx.jar

- pom.xml
- LICENSE.txt
- NOTICE.txt
- README.txt

## 2. 默认 maven 打包方式

如果没有特殊的配置，maven 会按照如下方式打包：

- src/main/java 和 src/test/java 目录下面的\*.java 文件会在 compile 和 test-compile 阶段被编译，编译结果分别放到 target/classes 和 target/test-classes 目录中。

- /src/main/resources 和 src/test/resources 这两个目录的内容则是直接被复制到 target/classes 和 target/test-classes 目录中。

## 3. 利用 \<resources\> 解决两个问题

1. 如果我们只希望将 resources 目录下面的部分内容打包，可以如下设置：

在 pom 文件中添加如下内容：下面的例子中，剔除了 static 目录及目录下的所有内容。

```xml
<build>
    <resources>
        <resource>
            <directory>src/main/resources</directory>
            <excludes>
                <exclude>static/**</exclude>
            </excludes>
        </resource>
    </resources>
</build>
```

2. 如果我们希望将 /src/main/java 目录下的非 \*.java 文件也打包进对应目录，可以如下配置 pom 文件：

```xml
<build>
       <!-- 资源目录 -->
        <resources>
            <resource>
                <!-- 设定主资源目录  -->
                <directory>src/main/java</directory>

                <!-- maven default生命周期，process-resources阶段执行maven-resources-plugin插件的resources目标处理主资源目下的资源文件时，只处理如下配置中包含的资源类型 -->
                <includes>
                    <include>**/*.xml</include>
                </includes>

                <!-- maven default生命周期，process-resources阶段执行maven-resources-plugin插件的resources目标处理主资源目下的资源文件时，不处理如下配置中包含的资源类型（剔除下如下配置中包含的资源类型）-->
                <excludes>
                    <exclude>**/*.yaml</exclude>
                </excludes>

                <!-- maven default生命周期，process-resources阶段执行maven-resources-plugin插件的resources目标处理主资源目下的资源文件时，指定处理后的资源文件输出目录，默认是${build.outputDirectory}指定的目录-->
                <!--<targetPath>${build.outputDirectory}</targetPath> -->

                <!-- maven default生命周期，process-resources阶段执行maven-resources-plugin插件的resources目标处理主资源目下的资源文件时，是否对主资源目录开启资源过滤 -->
                <filtering>true</filtering>
            </resource>
        </resources>
  </build>
```

## 4. 依赖放到外部的 lib 目录中

把所有第三方依赖打入到单独的 lib 中不打入 jar 中，使用 lib 设置依赖目录，资源文件复制一份到 config 中注意这里复制的资源文件。

```xml

<plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>2.20.1</version>
                <configuration>
                    <!-- 不指定单元测试 -->
                    <skipTests>true</skipTests>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-jar-plugin</artifactId>
                <configuration>
                    <archive>
                        <manifest>
                            <addClasspath>true</addClasspath>
                            <classpathPrefix>lib/</classpathPrefix>
                            <mainClass>*.*Application</mainClass>
                        </manifest>
                    </archive>
                    <!--<excludes>-->
                        <!--<exclude>application*.properties</exclude>  &lt;!&ndash; 业务jar中过滤applicationproperties文件，在jar包外控制 &ndash;&gt;-->
                    <!--</excludes>-->
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>    <!-- hot deploy  -->
                    <includes>   <!-- exclude third part jar files -->
                        <include>
                            <groupId>nothing</groupId>
                            <artifactId>nothing</artifactId>
                        </include>
                    </includes>
                    <classifier>exec</classifier>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>copy-dependencies</id>
                        <phase>prepare-package</phase>
                        <goals>
                            <goal>copy-dependencies</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.directory}/lib</outputDirectory>
                            <overWriteReleases>false</overWriteReleases>
                            <overWriteSnapshots>false</overWriteSnapshots>
                            <overWriteIfNewer>true</overWriteIfNewer>
                            <!-- 是否不包含间接依赖 -->
                            <excludeTransitive>false</excludeTransitive>
                            <!-- 忽略版本 -->
                            <stripVersion>false</stripVersion>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <!-- maven资源文件复制插件 -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
                <executions>
                    <execution>
                        <id>copy-resources</id>
                        <!-- here the phase you need -->
                        <phase>package</phase>
                        <goals>
                            <goal>copy-resources</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.directory}/config</outputDirectory>
                            <resources>
                                <resource>
                                    <directory>src/main/resources</directory>
                                    <includes>
                                        <include>**/*.*</include>
                                    </includes>
                                    <filtering>true</filtering>
                                </resource>
                                <!--<resource>-->
                                    <!--<directory>/</directory>-->
                                    <!--<includes>-->
                                        <!--<include>*.bat</include>-->
                                    <!--</includes>-->
                                    <!--<filtering>true</filtering>-->
                                <!--</resource>-->
                            </resources>
                            <encoding>UTF-8</encoding>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
```
