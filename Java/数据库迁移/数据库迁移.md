[TOC]

# 数据库迁移

如果是第一次听这个名词都会有几个基本的疑问：

- 什么是数据库迁移？
- 为什么需要管理数据库迁移？

我们接下来先回答这两个最基本的问题。

## 1. 什么是数据库迁移

数据库的状态发生了改变，那么就成为数据库发生了迁移。这可以包括数据库的设置、数据表、数据本身发生了修改。

## 2. 为什么需要数据库迁移

比如第一个版本的产品只包含了最基本的功能，而第二版本就需要增加评论功能，这就涉及到数据结构的修改（包括创建新表，修改旧表的列，增加已有表的列等等）。直接进入产品数据库修改数据库并不适合快速的开发节奏，不仅仅不安全，更多的情况下数据库可能并不对外或者并不适合对外直接暴露连接，比如PAAS平台的数据库以服务的形式直接提供。

对比代码管理的一些实践，很明显在数据库方面做的还欠缺很多。比如代码管理中我们有

- 版本管理（svn，git等等）
- 持续集成技术
- 良好的发布工具和流程

而在数据库方面会遇到很多问题

- 某台数据库现在是什么状态
- 修改变更的脚本是否已经应用
- 对于生产环境的紧急修复有没有被应用在测试环境
- 如何创建一个新的数据库实例

数据库迁移工具可以很好的管理这些问题，并提供了以下特性

- 从迁移脚本中创建新的数据库
- 检查数据库状态
- 从一个版本快速到达另外一个版本

## 3. Flyway和Liquibase对比[1]

Spring Boot为两款流行的数据库迁移库提供了自动配置支持。
    Flyway（http://flywaydb.org）
    Liquibase（http://www.liquibase.org）

### 3.1 用Flyway定义数据库迁移过程

1. 原理

Flyway是一个非常简单的开源数据库迁移库，使用SQL来定义迁移脚本。它的理念是，每个脚本都有一个版本号，Flyway会顺序执行这些脚本，让数据库达到期望的状态。它也会记录已执行的脚本状态，不会重复执行。Flyway脚本就是SQL。让其发挥作用的是其在Classpath里的位置和文件名。Flyway脚本都遵循一个命名规范，含有版本号。例如：V2_test.sql。所有Flyway脚本的名字都以大写字母V开头，随后是脚本的版本号。后面跟着两个下划线和对脚本的描述。Flyway脚本需要放在相对于应用程序Classpath根路径，在src/main/resources/db/migration路径下。在应用程序部署并运行起来后，Spring Boot会检测到Classpath里的Flyway，自动配置所需的Bean。Flyway会依次查看/db/migration里的脚本，如果没有执行过就运行这些脚本。每个脚本都执行过后，向schema_version表里写一条记录。应用程序下次启动时，Flyway会先看schema_version里的记录，跳过那些脚本。

2. 优点：SQL用起来便捷顺手。

3. 缺点：无法跨平台使用。

### 3.2 用Liquibase定义数据库迁移过程

1. 原理：

支持XML、YAML和JSON格式的迁移脚本。默认情况下，Bean会在/db/changelog（相对于Classpath根目录）里查找db.changelog-master.yaml文件。Liquibase变更集都集中在一个文件里。changeset命令后的那行有一个id属性，要对数据库进行后续变更。可以添加一个新的changeset，只要id不一样就行。此外，id属性也不一定是数字，可以包含任意内容。应用程序启动时，Liquibase会读取db.changelog-master.yaml里的变更集指令集，与之前写入databaseChangeLog表里的内容做对比，随后执行未运行过的变更集。

2. 优点：可以跨平台使用

3. 缺点：迁移脚本需要花费精力去维护

## 参考

1. [Flyway与Liquibase对比](https://blog.csdn.net/cenxuu/article/details/86685662)
