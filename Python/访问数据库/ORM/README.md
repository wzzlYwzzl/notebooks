[TOC]

# ORM

## 1. 什么是ORM

ORM，object relational map，关系对象映射。从名字上我们大致能理解ORM要解决的问题就是：连接面向对象和关系数据库，把object映射成关系数据库的表格。

![1](./images/1.png)

## 2. 为什么要使用ORM，其优势与劣势

我们从上一节的图中可以看出，ORM连接数据库和程序的对象。我们要回答为什么需要这一层，那么我们需要明白，如果没有ORM这一层，我们要做哪些工作？以及这些工作存在哪些难点？哪些不必要的重复？

我们从数据库开始分析，到业务代码中的程序这个过程中，我们要经历哪些传统使用数据库的过程。

自下而上的第一层是不同语言针对数据库的驱动程序，比如ADO.Net，JDBC等。通过这些驱动，我们连接数据库，然后通过写好的SQL语句，然后从数据库获取不同类型的数据，这里的不同类型指的是int、float、string这些程序语言的数据类型。也就是我们通过数据库驱动获取的只是某种形态的数据，并不关心这些数据到底是描述哪些信息的。

然后我们把从数据库中获取的数据，按照我们构建的业务模型，构建成程序中的object。这些object就会在程序的整个基于业务的体系中开始运作、流通。

还有相反的一条路径，就是在对数据库进行增删改查时，会从程序的对象开始，然后拼接SQL语句，然后通过数据库驱动执行相应的操作。

ORM做的工作就是帮助你做上面的提到的工作，让你直接可以得到object。

**额外的思考：**
在思考ORM的作用过程中，我对面向对象的软件设计有了新的思考。这份思考记录在《Thinking/关于软件内部设计的思考》一文中。

### 2.1 优势

- ORM主要解决对象与关系的映射。通常，一个类和一张表对应，类的每个实例对应表中的一条记录，类的每个属性对应表中的每个字段。
- 通过ORM，可以不用编写SQL代码，只需要像操作对象一样操作数据库。
- 更专注业务逻辑，提高效率。

**思考**：新的技术或者框架，都是在让程序员不像程序员，帮助程序员脱离低级重复的程序，进而专注于业务层面的设计和思考。

### 2.2 缺点

- 一定程度上牺牲了程序的执行效率，因为框架生成的SQL都是出自提前定义好的模板，很难对具体的场景对SQL进行优化，某些场景下会生成执行很慢的SQL。
- 经常使用ORM，SQL技能会退化。

## 3. ORM的原理

ORM帮我们主要做了下面三件事：

1. 数据到对象的映射
   通过反射可以获取对象的属性，然后将从数据库表中获取的数据赋值给这些属性。

2. sql语句拼写
   内部通过一套模板，将对对象属性的操作拼接成SQL。

3. 数据缓存
   ORM通过缓存来减少数据库的访问次数。

## 4. 如果要设计一个ORM要考虑哪些

## 5. 常见的ORM框架

### 5.1 .net体系

- EntityFramework，功能强大，lambda api，有些庞大臃肿，很多功能用不上
- Dapper，轻量级，数据库种类支持丰富，sql写法灵活，运行速度快
- CYQ.Data，自动化，日志，分布式缓存，弱类型，api简介

### 5.2 java体系

- MyBatis，映射采用Xml配置sql，多种映射关系灵活配置，sql需要手动编写到配置，轻量级，半自动
- Hibernate，Xml配置sql，支持HQL语句，移植性好，日志，重量级，功能全，全自动
- Speedment，lambda api，依赖java8

### 5.3 python体系

- SQLalchemy，SQLAlchemy是一个开源的SQL工具包，基本Python编程语言的MIT许可证而发布的对象关系映射器。SQLAlchemy提供了“一个熟知的企业级全套持久性模式，专为高效率和高性能的数据库访问而设计“。SQLAlchemy的首次发布2006年2月，并已迅速成为最广泛使用的对象关系映射在Python社区的工具之一。
- Peewee
- Django ORM，不是一个全功能的ORM，有些SQL无法通过ORM完成。(新的版本功能可能已经完善)
